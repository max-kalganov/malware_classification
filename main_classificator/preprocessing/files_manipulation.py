from os import listdir
from os.path import join, isfile
from random import sample
from shutil import copy
from typing import List, Mapping

import pandas as pd

from main_classificator import ct
from main_classificator.utils import Extention, get_file_name_by_extention


def get_all_file_names(path_to_folder: str) -> List[str]:
    return [join(path_to_folder, f) for f in listdir(path_to_folder) if isfile(join(path_to_folder, f))]


def get_num_of_files(path_to_folder: str, ext: Extention = None) -> int:
    list_dir = listdir(path_to_folder)
    return len(list_dir) if not ext else len(get_file_name_by_extention(list_dir, ext))


def read_data_from_files(file_names: List[str]) -> Mapping[str, str]:
    def get_short_name(long_name: str) -> str:
        return long_name.split('/')[-1]
    all_data = {}
    for path in file_names:
        full_input = []
        with open(path, 'r', errors='ignore') as file:
            full_input.append(file.read())

        assert len(full_input) == 1, f"len of input is not 1, but = {len(full_input)}"
        all_data[get_short_name(path)] = full_input[0]
    assert len(file_names) == len(all_data.keys()), f"len of input {len(file_names)} " \
        f"is not the same to len of output {all_data.keys()}"
    return all_data


def read_labels(path_to_labels: str) -> pd.DataFrame:
    assert path_to_labels[-4:] == '.csv', f"wrong path entered {path_to_labels}"
    labels = pd.read_csv(path_to_labels)
    return labels


def get_sample_by_labels(labels_df: pd.DataFrame) -> pd.DataFrame:
    def proc_groups(name, group):
        return pd.DataFrame({ct.ID_COLUMN: [sample(list(group[ct.ID_COLUMN].values), ct.SAMPLE_SIZE)],
                             ct.CLASS_COLUMN: [name]})

    df = pd.concat([proc_groups(name, group) for name, group in labels_df.groupby([ct.CLASS_COLUMN])])
    return df


def copy_files_in_folder(df_with_ids: pd.DataFrame, src_folder: str, dst_folder: str):
    def copy_file(id_names: List[str]):
        for file_name in id_names:
            copy(src_folder + file_name + '.asm', dst_folder)
            copy(src_folder + file_name + '.bytes', dst_folder)
        return id_names
    df_with_ids[ct.ID_COLUMN].apply(copy_file)


def devide_train_sample_df():
    labels = read_labels(ct.get_path_to_train_labels_csv())
    samples = get_sample_by_labels(labels)
    copy_files_in_folder(df_with_ids=samples,
                         src_folder=ct.get_path_to_train_folder(),
                         dst_folder=ct.get_path_to_train_cut_folder())


def delete_files_with_ext(path_to_folder: str, ext: Extention):
    import os

    def delete_files(file_names: List[str]):
        for file in file_names:
            os.remove(file)

    file_names = get_all_file_names(path_to_folder)
    file_names = get_file_name_by_extention(file_names, ext)
    delete_files(file_names)


if __name__ == '__main__':
    delete_files_with_ext(ct.get_path_to_train_folder(), ext=Extention.ASM)
